name: Setup D1 Database

on:
  workflow_dispatch:
    inputs:
      database_name:
        description: 'Database name'
        required: true
        default: 'gaado-db'
      environment:
        description: 'Environment (production/staging)'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  setup-d1:
    runs-on: ubuntu-latest
    name: Create and Initialize D1 Database
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Create D1 Database
        id: create-db
        run: |
          echo "Creating D1 database: ${{ inputs.database_name }}"
          DB_OUTPUT=$(wrangler d1 create "${{ inputs.database_name }}" 2>&1)
          echo "$DB_OUTPUT"
          
          # Extract database_id
          DB_ID=$(echo "$DB_OUTPUT" | grep -oP 'database_id = "\K[^"]+' | head -1 || echo "")
          
          if [ -z "$DB_ID" ]; then
            DB_ID=$(echo "$DB_OUTPUT" | grep -oP 'id.*?=.*?"\K[^"]+' | head -1 || echo "")
          fi
          
          if [ -z "$DB_ID" ]; then
            echo "âŒ Could not extract database_id"
            exit 1
          fi
          
          echo "database_id=$DB_ID" >> $GITHUB_OUTPUT
          echo "âœ… Database created with ID: $DB_ID"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Initialize Schema
        run: |
          echo "Initializing database schema..."
          wrangler d1 execute "${{ inputs.database_name }}" --file=database/schema.sql
          echo "âœ… Schema initialized"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Output Database Info
        run: |
          echo "## Database Setup Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Database Name:** ${{ inputs.database_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Database ID:** ${{ steps.create-db.outputs.database_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update \`wrangler.toml\` with the database_id above" >> $GITHUB_STEP_SUMMARY
          echo "2. Add the following to your \`wrangler.toml\`:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`toml" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "[[env.production.d1_databases]]" >> $GITHUB_STEP_SUMMARY
          else
            echo "[[env.staging.d1_databases]]" >> $GITHUB_STEP_SUMMARY
          fi
          echo "binding = \"DB\"" >> $GITHUB_STEP_SUMMARY
          echo "database_name = \"${{ inputs.database_name }}\"" >> $GITHUB_STEP_SUMMARY
          echo "database_id = \"${{ steps.create-db.outputs.database_id }}\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

